# Реализация "Layered Health Check" для борьбы с ложными отключениями

## Обзор

В системе мониторинга сайтов реализована многоуровневая проверка доступности ("Layered Health Check") для борьбы с ложными срабатываниями, когда сайт блокирует бота (403 Forbidden) или медленно отвечает.

## Архитектура

### Шаг 1: HTTP-проверка через curl_cffi
- Используется библиотека `curl_cffi` с имперсонацией браузера Chrome 120
- Таймаут запроса: 30 секунд
- При успешном ответе (200-299) сайт считается доступным
- При получении 403/401 выполняется переход к Шагу 2
- При других ошибках HTTP (4xx, 5xx) сайт считается недоступным
- При таймауте или других ошибках сети выполняется переход к Шагу 2

### Шаг 2: TCP-проверка
- Проверяется возможность установить TCP-соединение с хостом
- Порт: 443 для HTTPS, 80 для HTTP
- Таймаут соединения: 5 секунд
- При успешном соединении сайт помечается как "доступен (TCP-только)"
- При неудаче сайт считается недоступным

### Шаг 3: Решение о статусе
- Сайт считается DOWN только если BOTH HTTP и TCP проверки неудачны
- Сайт считается UP если:
  - HTTP проверка успешна (200-299)
  - HTTP вернула 403/401, но TCP проверка успешна
  - HTTP проверка неудачна, но TCP проверка успешна

## Ключевые функции

### `check_site_availability(url)`
Основная функция, реализующая логику "Layered Health Check".
Возвращает кортеж: `(is_available, status_code, response_time, page_title, final_url, check_type)`

### `tcp_check(url)`
Функция проверки TCP-соединения.
Возвращает кортеж: `(is_available, response_time)`

### `check_site_fallback_aiohttp(url, start_time)`
Fallback-функция, используемая если curl_cffi недоступен.
Реализует ту же логику "Layered Health Check".

## Преимущества реализации

1. **Снижение ложных срабатываний**: Сайты, блокирующие ботов, не помечаются как недоступные
2. **Устойчивость к медленным сайтам**: Таймауты не приводят к ложным отключениям
3. **Гибкость**: Поддержка curl_cffi и fallback на aiohttp
4. **Информативность**: Различные типы проверок для детального анализа

## Примеры использования

```python
# Проверка сайта с многоуровневой логикой
is_available, status_code, response_time, page_title, final_url, check_type = await check_site_availability("https://example.com")

if is_available:
    if check_type == "tcp_only":
        print("Сайт блокирует бота, но доступен по TCP")
    else:
        print("Сайт полностью доступен по HTTP")
else:
    print("Сайт недоступен и по HTTP, и по TCP")
```

## Тестирование

Для тестирования реализованы скрипты:
- `test_layered_health_check.py` - комплексное тестирование различных сценариев
- `test_403_scenario.py` - специфическое тестирование сценария с 403 Forbidden

## Результаты

Реализация "Layered Health Check" позволяет значительно снизить количество ложных уведомлений о недоступности сайтов, особенно для:
- Сайтов с защитой от ботов (WAF, Cloudflare)
- Медленных сайтов
- Сайтов с временными проблемами на уровне HTTP