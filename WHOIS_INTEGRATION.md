# Интеграция WHOIS Watchdog в основной бот

## Обзор

WHOIS Watchdog - это отдельный модуль для мониторинга истечения доменов с использованием WHOIS. Он интегрируется в основной бот мониторинга сайтов как дополнительный функционал.

## Файлы

1. `domain_monitor_schema.sql` - SQL схема для таблицы `botmonitor_domain_monitor`
2. `whois_watchdog.py` - Основная логика WHOIS Watchdog
3. `whois_integration.py` - Интеграция с основным ботом
4. `WHOIS_INTEGRATION.md` - Этот файл с инструкциями

## Установка и настройка

### 1. Создание таблицы в базе данных

Выполните SQL из файла `domain_monitor_schema.sql` в вашей базе данных Supabase:

```sql
-- Создание таблицы botmonitor_domain_monitor для WHOIS Watchdog
CREATE TABLE IF NOT EXISTS botmonitor_domain_monitor (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    domain_name VARCHAR(255) NOT NULL UNIQUE,
    current_expiry_date DATE NOT NULL,
    admin_chat_id BIGINT NOT NULL,
    project_chat_id BIGINT NOT NULL,
    is_reserve_domain BOOLEAN DEFAULT FALSE,
    last_check_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Создание индекса для быстрого поиска по домену
CREATE INDEX IF NOT EXISTS idx_botmonitor_domain_monitor_domain_name ON botmonitor_domain_monitor(domain_name);

-- Создание индекса для даты последней проверки
CREATE INDEX IF NOT EXISTS idx_botmonitor_domain_monitor_last_check_date ON botmonitor_domain_monitor(last_check_date);

-- Создание индекса для флага резервного домена
CREATE INDEX IF NOT EXISTS idx_botmonitor_domain_monitor_is_reserve ON botmonitor_domain_monitor(is_reserve_domain);

-- Добавление комментария к таблице
COMMENT ON TABLE botmonitor_domain_monitor IS 'Таблица для мониторинга истечения срока действия доменов через WHOIS';
```

### 2. Установка зависимостей

Добавьте библиотеку `asyncwhois` в `requirements.txt` (уже добавлено):

```
asyncwhois==0.2.5
```

Установите зависимости:

```bash
pip install -r requirements.txt
```

### 3. Интеграция в основной бот

В файле `main.py` добавьте следующий код:

```python
# Импорты в начале файла
from whois_integration import register_whois_handlers, start_whois_watchdog

# В функции main() перед запуском supervisor():
async def main():
    init_db()
    
    # Загружаем кэш резервных доменов
    await load_reserve_domains_cache()
    
    # Регистрируем обработчики WHOIS Watchdog
    register_whois_handlers(dp, supabase, bot)
    
    # Запускаем WHOIS Watchdog
    await start_whois_watchdog(supabase, bot)
    
    # ... остальной код
```

## Функционал

### Команды бота

1. `/adddomain` - Добавление домена в WHOIS мониторинг
   - Запрашивает имя домена
   - Автоматически получает дату истечения через WHOIS
   - Запрашивает ID чата для технических уведомлений
   - Запрашивает ID чата для публичных уведомлений

2. `/whoislist` - Показывает список всех доменов в WHOIS мониторинге
   - Отображает домен, дату истечения, количество дней до истечения
   - Показывает ID чатов для уведомлений
   - Показывает дату последней проверки

3. `/checkwhois <domain>` - Проверяет WHOIS для указанного домена
   - Возвращает дату истечения и количество дней до нее
   - Показывает статус домена (активен/скоро истекает/истёк)

4. `/whoisreserve <domain>` - Переключает статус резервного домена
   - Изменяет статус домена между обычным и резервным
   - Резервные домены не проверяются на доступность

5. `/syncwhois` - Показывает сайты из основной таблицы без даты истечения домена
   - Отображает сайты без domain_expires_at
   - Показывает сайты с датой истечения, но не добавленные в WHOIS мониторинг
   - Помогает определить, какие сайты нужно добавить в WHOIS мониторинг

6. `/autowhois` - Автоматически добавляет домены без даты истечения в WHOIS мониторинг
   - Ищет сайты с пустым полем domain_expires_at
   - Получает дату истечения через WHOIS
   - Добавляет в WHOIS мониторинг с теми же chat_id

### Логика работы

1. **Ежедневная проверка** (в 10:00 UTC):
   - Проверяет все домены в таблице `botmonitor_domain_monitor`
   - Получает актуальную дату истечения через WHOIS
   - Сравнивает с текущей датой в БД

2. **Обнаружение продления**:
   - Если новая дата позже текущей более чем на 30 дней
   - Отправляет уведомление администратору с кнопками подтверждения
   - Обновляет дату только после подтверждения

3. **Напоминания об истечении**:
   - За 30, 7, 3, 1 день до истечения
   - Отправляет уведомления в admin_chat_id и project_chat_id

4. **Подтверждение обновления**:
   - Администратор нажимает "✅ Да, обновить"
   - Бот обновляет дату в БД
   - Отправляет уведомление о продлении в project_chat_id

## Архитектура

### Таблица botmonitor_domain_monitor

- `id` - Уникальный идентификатор записи
- `domain_name` - Имя домена (уникальное)
- `current_expiry_date` - Текущая подтвержденная дата истечения
- `admin_chat_id` - ID чата для технических уведомлений
- `project_chat_id` - ID чата для публичных уведомлений
- `is_reserve_domain` - Флаг резервного домена (true/false)
- `last_check_date` - Дата последней проверки WHOIS
- `created_at` - Дата создания записи
- `updated_at` - Дата обновления записи

### Философия "Trust but Verify"

Бот следует принципу "Доверяй, но проверяй":
1. Бот обнаруживает изменение даты через WHOIS
2. Но обновляет БД только после подтверждения администратором
3. Это защищает от ошибок парсинга WHOIS данных

### Callback данные

- `whois_confirm:{domain_id}:{new_date}` - Подтверждение обновления
- `whois_reject:{domain_id}` - Отклонение обновления

## Преимущества

1. **Надежность**: Использует проверенную библиотеку asyncwhois
2. **Гибкость**: Отдельные чаты для технических и публичных уведомлений
3. **Безопасность**: Подтверждение обновлений администратором
4. **Интеграция**: Полностью интегрируется с существующим ботом
5. **Масштабируемость**: Легко добавлять новые домены в мониторинг
6. **Управление статусами**: Поддержка резервных доменов с отключенной проверкой доступности
7. **Автоматическая синхронизация**: Возможность автоматически добавлять домены из основной таблицы
8. **Удобное управление**: Команды для просмотра и синхронизации данных между таблицами

## Примечания

1. WHOIS проверки выполняются ежедневно в 10:00 UTC
2. Бот обрабатывает ошибки WHOIS и не отправляет спам
3. Все уведомления локализованы на русский язык
4. Поддерживаются кириллические домены (.рф)
5. Используются существующие функции безопасной работы с Supabase
6. Резервные домены отслеживаются только по дате истечения, без проверки доступности
7. При автоматическом добавлении доменов используются chat_id из основной таблицы
8. Команда /autowhois обрабатывает ошибки WHOIS и продолжает работу с другими доменами