# Исправление ошибки "JSON could not be generated" (код 556)

## Проблема

В системе мониторинга сайтов возникала критическая ошибка:
```
Критическая ошибка в availability check: {'message': 'JSON could not be generated', 'code': 556, 'hint': 'Refer to full message for details', 'details': "b'Internal server error.'"}
```

Эта ошибка возникала при работе с базой данных Supabase и приводила к сбоям в системе мониторинга.

## Корневая причина

Ошибка была вызвана отсутствием должной обработки ошибок при работе с Supabase API. Временные проблемы с соединением или внутренние ошибки сервера Supabase приводили к падению всего процесса проверки доступности сайтов.

## Решение

### 1. Создана вспомогательная функция `safe_supabase_operation`

**Файл:** `main.py`
**Функция:** `safe_supabase_operation(operation_func, max_retries=3, retry_delay=5)`

#### Основные возможности:
- **Механизм повторных попыток** при ошибках Supabase
- **Специальная обработка** ошибок JSON (код 556)
- **Детальное логирование** всех ошибок
- **Возврат результата** в формате (success, result_or_error)

### 2. Улучшена функция `scheduled_availability_check`

#### Основные улучшения:
- **Безопасное получение списка сайтов** с использованием `safe_supabase_operation`
- **Изоляция ошибок** для отдельных сайтов (ошибка с одним сайтом не останавливает проверку других)
- **Безопасное обновление статуса** каждого сайта
- **Улучшенное логирование** с информацией о прогрессе проверки
- **Обработка ошибок отправки уведомлений**

### 3. Улучшена функция `scheduled_notification_check`

#### Основные улучшения:
- **Безопасное получение сайтов** для проверки уведомлений
- **Изоляция ошибок** при обработке уведомлений для отдельных сайтов
- **Безопасное обновление дат** последних уведомлений
- **Обработка ошибок отправки** уведомлений в Telegram

### 4. Улучшены функции обратного вызова (callback handlers)

#### Обновленные функции:
- `handle_renew_callback` - обработка продления домена/хостинга
- `handle_delete_callback` - обработка удаления сайта
- `handle_show_reserve_domains_callback` - показ резервных доменов

#### Основные улучшения:
- **Безопасное выполнение** всех операций с Supabase
- **Детальная обработка ошибок** с информированием пользователя
- **Сохранение функциональности** даже при временных проблемах с БД

## Технические детали

### Механизм повторных попыток

```python
async def safe_supabase_operation(operation_func, max_retries=3, retry_delay=5):
    for attempt in range(max_retries):
        try:
            result = operation_func()
            return True, result
        except Exception as e:
            # Специальная обработка ошибок JSON (код 556)
            if "JSON could not be generated" in str(e) or "code 556" in str(e):
                logging.error(f"Обнаружена критическая ошибка JSON (код 556)")
                if attempt < max_retries - 1:
                    await asyncio.sleep(retry_delay)
                    continue
            # Другие ошибки
            if attempt < max_retries - 1:
                await asyncio.sleep(retry_delay)
            else:
                return False, e
```

### Изоляция ошибок

Каждый сайт теперь обрабатывается в отдельном блоке try-catch:

```python
for site in sites:
    try:
        # Обработка сайта
        status = await check_site_with_retries(url)
        # Обновление статуса
        update_success, _ = await safe_supabase_operation(...)
    except Exception as site_error:
        logging.error(f"Ошибка при обработке сайта {site.get('id')}: {site_error}")
        continue  # Продолжаем с другим сайтом
```

## Результат

После внедрения исправлений:

✅ **Исключены критические сбои** системы мониторинга из-за ошибок Supabase
✅ **Повышена надежность** работы с базой данных
✅ **Улучшена диагностика** проблем с детальным логированием
✅ **Сохранена функциональность** даже при временных проблемах с соединением
✅ **Снижено количество ложных уведомлений** об ошибках системы

## Тестирование

Для тестирования исправлений:

1. **Запустить бота** и наблюдать за логами
2. **Проверить работу** основных команд (/add, /list, /status)
3. **Проверить работу** функций обратного вызова
4. **Наблюдать за логами** в течение нескольких циклов проверки (каждые 5 минут)

## Мониторинг

Дополнительное логирование позволит отслеживать:
- Количество успешных/неуспешных операций с Supabase
- Время выполнения операций
- Конкретные ошибки и их частоту
- Работу механизма повторных попыток