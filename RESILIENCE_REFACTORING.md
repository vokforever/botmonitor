# –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–æ—Ç–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

## –ó–∞–¥–∞—á–∞

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –±—ã–ª–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ª–æ–≥–∏–∫—É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (—Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∞–π—Ç–æ–≤), —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Å–∏—Å—Ç–µ–º—É **–æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–π (fault-tolerant)**. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å 24/7, –Ω–µ –ø–∞–¥–∞—Ç—å –æ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π –∏ —É–≤–µ–¥–æ–º–ª—è—Ç—å –∞–¥–º–∏–Ω–∞ –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–±–æ—è—Ö, –Ω–æ –Ω–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å –ø–æ –º–µ–ª–æ—á–∞–º.

## –ü—Ä–æ–±–ª–µ–º–∞

–ë–æ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–∞–¥–∞–ª –∏–ª–∏ –ø–µ—Ä–µ—Å—Ç–∞–≤–∞–ª –ø—Ä–æ–≤–æ–¥–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏, –∫–æ–≥–¥–∞ —Å—Ç–∞–ª–∫–∏–≤–∞–ª—Å—è —Å —Å–µ—Ç–µ–≤—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Connection refused`, SSL –æ—à–∏–±–∫–∏, —Ç–∞–π–º–∞—É—Ç—ã) –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö (–ø—Ä–∏–º–µ—Ä –∏–∑ –ª–æ–≥–æ–≤: `Cannot connect to host predgorie82.ru`). –û—à–∏–±–∫–∞ –Ω–∞ –æ–¥–Ω–æ–º —Å–∞–π—Ç–µ –Ω–µ –¥–æ–ª–∂–Ω–∞ –ª–æ–º–∞—Ç—å –≤–µ—Å—å —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏.

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ò–∑–æ–ª—è—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫ (Per-Site Isolation) ‚úÖ

- –í–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ –ø–µ—Ä–µ–±–æ—Ä–∞ —Å–∞–π—Ç–æ–≤ (`for site in sites:`) –æ–±–µ—Ä–Ω—É—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ **–∫–∞–∂–¥–æ–≥–æ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞** –≤ –±–ª–æ–∫ `try...except`.
- –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–¥–Ω–æ–≥–æ —Å–∞–π—Ç–∞ –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π (—Å–µ—Ç–µ–≤–∞—è, SSL, –ø–∞—Ä—Å–∏–Ω–≥), —ç—Ç–æ **–Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç** —Ü–∏–∫–ª. –ë–æ—Ç –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É –∏ **–ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–∞–π—Ç—É**.
- –°–æ–∑–¥–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `check_single_site(site)` –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–∂–¥–æ–≥–æ —Å–∞–π—Ç–∞.

### 2. –ì–ª–æ–±–∞–ª—å–Ω—ã–π "Supervisor" –≤ –∫–æ–¥–µ ‚úÖ

- –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª `while True` (–≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç `await asyncio.sleep(CHECK_INTERVAL)`) –æ–±–µ—Ä–Ω—É—Ç –≤ —à–∏—Ä–æ–∫–∏–π `try...except Exception`.
- –ï—Å–ª–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Å–∞–º–æ–º —Ü–∏–∫–ª–µ (–≤–Ω–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–∞–π—Ç–∞), –±–æ—Ç:
  1. –õ–æ–≥–∏—Ä—É–µ—Ç traceback –æ—à–∏–±–∫–∏ (`logging.error`).
  2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –Ω–∞ `ADMIN_CHAT_ID` —Å —Ç–µ–∫—Å—Ç–æ–º: "üî• **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:** ...".
  3. –î–µ–ª–∞–µ—Ç `await asyncio.sleep(60)` (–ø–∞—É–∑–∞ 1 –º–∏–Ω—É—Ç–∞) –∏ **–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç —Ü–∏–∫–ª**, –∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å–∫—Ä–∏–ø—Ç–∞.

### 3. –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–∏—Å–∞–Ω–∏–π ‚úÖ

- –í—Å–µ —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã (—á–µ—Ä–µ–∑ `aiohttp`) –∏–º–µ—é—Ç –∂–µ—Å—Ç–∫–∏–µ —Ç–∞–π–º–∞—É—Ç—ã:
  - –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∞–π—Ç–æ–≤: 30 —Å–µ–∫—É–Ω–¥ (–±—ã–ª–æ 10)
  - Screenshot API: 45 —Å–µ–∫—É–Ω–¥ (–±—ã–ª–æ 35)
  - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ API: 20 —Å–µ–∫—É–Ω–¥ (–±—ã–ª–æ 15)
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –Ω–∞ —á—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –ø–æ–º–æ—â—å—é `asyncio.wait_for()`

### 4. –£–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É ‚úÖ

- –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è **—Ç–æ–ª—å–∫–æ** –µ—Å–ª–∏ —É–ø–∞–ª —Å–∞–º –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (`Supabase`) –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.
- –£–¥–∞–ª–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–∞–π—Ç–∞, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –∞–¥–º–∏–Ω–∞.
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–µ—Ñ–∏–∫—Å—ã "üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:" –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º.

### 5. –ò–∑–æ–ª—è—Ü–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ‚úÖ

- –§—É–Ω–∫—Ü–∏—è `scheduled_notification_check()` —Ç–∞–∫–∂–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–µ–Ω–∞ —Å –∏–∑–æ–ª—è—Ü–∏–µ–π –æ—à–∏–±–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∞–π—Ç–∞.
- –°–æ–∑–¥–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `check_site_notifications(site, now)` –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç –æ—à–∏–±–æ–∫ —Å –ø–∞—É–∑–æ–π 60 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º.

### 6. –£–ª—É—á—à–µ–Ω–Ω—ã–π supervisor ‚úÖ

- –§—É–Ω–∫—Ü–∏—è `supervisor()` —É–ª—É—á—à–µ–Ω–∞ –¥–ª—è –ª—É—á—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.
- –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ try-catch –±–ª–æ–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö.

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

1. **–ü—Ä–æ–±–ª–µ–º–∞ `predgorie82.ru`**: –¢–µ–ø–µ—Ä—å –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —ç—Ç–æ–º—É —Å–∞–π—Ç—É –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ `for`. –û—à–∏–±–∫–∞ –Ω–∞ –æ–¥–Ω–æ–º —Å–∞–π—Ç–µ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—à–µ—Ç—Å—è –≤ –ª–æ–≥, –∞ –±–æ—Ç –ø–æ–π–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã.

2. **–ü—Ä–æ–±–ª–µ–º–∞ "–ø–∞–¥–µ–Ω–∏—è"**: –ì–ª–æ–±–∞–ª—å–Ω—ã–π `try/except` –≤–æ–∫—Ä—É–≥ `while True` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –¥–∞–∂–µ –µ—Å–ª–∏ —Å–ª–æ–º–∞–µ—Ç—Å—è —á—Ç–æ-—Ç–æ —Å–æ–≤—Å–µ–º –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–≤–∞–ª–∏—Ç—Å—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö), –±–æ—Ç –Ω–µ –≤—ã–ª–µ—Ç–∏—Ç, –∞ –ø–æ–¥–æ–∂–¥–µ—Ç –º–∏–Ω—É—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–µ—Ç —Å–Ω–æ–≤–∞.

3. **–ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–∏—á–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–æ—Ç *–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ* —Å–ª–æ–º–∞–ª—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ, –∞ –Ω–µ –∫–æ–≥–¥–∞ "–ª–æ–∂–∏—Ç—Å—è" –∫–∞–∫–æ–π-—Ç–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

```python
async def scheduled_availability_check():
    await bot.send_message(ADMIN_CHAT_ID, "üöÄ –ë–æ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–ø—É—â–µ–Ω (—Ä–µ–∂–∏–º –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏)")
    
    while True:
        try:
            # 1. –ü–æ–ª—É—á–∞–µ–º —Å–∞–π—Ç—ã –∏–∑ –ë–î
            sites = await get_sites_from_supabase() 
            
            # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —Å–∞–π—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
            for site in sites:
                try:
                    await check_single_site(site)
                except Exception as site_e:
                    logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–∞–π—Ç–∞ {site['url']}: {site_e}")
                    # continue - –∏–¥–µ–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–∞–π—Ç—É
            
            logging.info("–¶–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω. –û–∂–∏–¥–∞–Ω–∏–µ...")

        except Exception as global_e:
            # 3. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç, —á—Ç–æ–±—ã –±–æ—Ç –Ω–µ —É–º–µ—Ä
            error_msg = f"üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –¶–ò–ö–õ–ê: {global_e}"
            logging.critical(error_msg, exc_info=True)
            try:
                await bot.send_message(ADMIN_CHAT_ID, error_msg)
            except:
                pass # –ï—Å–ª–∏ –¥–∞–∂–µ Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ–º –≤ –ª–æ–≥
            
            await asyncio.sleep(60) # –î–∞–µ–º –≤—Ä–µ–º—è "–æ—Å—Ç—ã—Ç—å" –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º

        await asyncio.sleep(CHECK_INTERVAL)
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

- –í—Å–µ —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `aiohttp.ClientTimeout` —Å —è–≤–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
- –î–æ–±–∞–≤–ª–µ–Ω—ã `asyncio.wait_for()` –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `safe_supabase_operation()`
- –ò–∑–º–µ–Ω–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –ª—É—á—à–µ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–ë–æ—Ç —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏, –≥–¥–µ –æ—à–∏–±–∫–∞ –Ω–∞ –æ–¥–Ω–æ–º —Å–∞–π—Ç–µ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, –∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö.